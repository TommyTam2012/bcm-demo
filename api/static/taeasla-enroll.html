<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TAEASLA 入學報名表</title>
  <style>
    :root {
      --bg:#0b1220;      /* deep space fallback */
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --accent:#0d6efd;  /* default blue (kept) */
      --ok:#16a34a;
      --bad:#dc2626;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans HK", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);      /* fallback if image fails */
      position:relative;
    }
    /* Background image layer (same vibe as info pages) */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:url("https://www.taeasla.com/image/office2.png") center/cover no-repeat fixed;
      z-index:-2;
    }
    /* Soft overlay for readability */
    body::after{
      content:"";
      position:fixed; inset:0;
      background:rgba(0,0,0,0.28);
      z-index:-1;
    }

    header { padding:24px 16px; text-align:center; }
    h1 { margin:0 0 6px; font-size:28px; color:#fff; }
    p.sub { margin:0; color:#e5e7eb; }

    main { max-width:760px; margin:24px auto 64px; padding:0 16px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 8px 24px rgba(15,23,42,.18); padding:20px; }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .row .full { grid-column:1 / -1; }

    label { display:block; font-weight:600; margin:10px 0 6px; }
    input, select, textarea {
      width:100%; padding:12px 12px;
      border:1px solid #e5e7eb; border-radius:10px; font-size:16px; background:#fff;
    }
    select { appearance:none; background-image: linear-gradient(45deg, transparent 50%, #999 50%), linear-gradient(135deg, #999 50%, transparent 50%), linear-gradient(to right, #fff, #fff); background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px), 100% 0; background-size: 5px 5px, 5px 5px, 2.5em 2.5em; background-repeat:no-repeat; }
    textarea { min-height:96px; resize:vertical; }
    .small { font-size:12px; color:var(--muted); margin-top:4px; }

    /* Submit button (neon blue glow like info page button) */
    button[type="submit"]{
      width:100%; padding:14px 16px; border:0; border-radius:12px; font-weight:800; font-size:18px;
      background:#0dcaf0; color:#fff; cursor:pointer;
      box-shadow:0 0 12px #0dcaf0, 0 0 24px rgba(13,202,240,0.6);
      transition:all .25s;
    }
    button[type="submit"]:hover{
      background:#00f0ff; color:#000;
      box-shadow:0 0 16px #00f0ff, 0 0 32px rgba(0,240,255,0.7);
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    .banner { margin-top:14px; padding:12px 14px; border-radius:10px; display:none; }
    .banner.ok  { display:block; background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .banner.bad { display:block; background:#fef2f2; color:#7f1d1d; border:1px solid #fecaca; }

    .meta { margin:8px 0 0; font-size:13px; color:var(--muted); }

    @media (max-width:600px){
      body::after{ background:rgba(0,0,0,0.36); }
    }
  </style>
</head>
<body>
  <header>
    <h1>TAEASLA 入學報名表</h1>
    <p class="sub">請填寫以下資料完成報名（座位有限）。</p>
  </header>

  <main>
    <div class="card">
      <form id="enrollForm" novalidate>
        <div class="row">
          <div class="full">
            <label for="course">選擇課程（以中文顯示）</label>
            <select id="course" name="course" required>
              <option value="">請選擇課程…</option>
            </select>
            <div class="small">請先選擇課程…</div>
          </div>

          <div class="full">
            <label for="full_name">學生姓名</label>
            <input id="full_name" name="full_name" type="text" placeholder="中文或英文姓名" required />
          </div>

          <div>
            <label for="phone">聯絡電話</label>
            <input id="phone" name="phone" type="tel" placeholder="例如：9123 4567" />
          </div>

          <div>
            <label for="email">電郵</label>
            <input id="email" name="email" type="email" placeholder="you@example.com" />
          </div>

          <div>
            <label for="timezone">時區</label>
            <input id="timezone" name="timezone" type="text" placeholder="例如：Asia/Hong_Kong" />
          </div>

          <div class="full">
            <label for="notes">備註</label>
            <textarea id="notes" name="notes" placeholder="其他需要告知的內容（可留空）"></textarea>
          </div>
        </div>

        <button id="submitBtn" type="submit">提交報名</button>

        <div id="okBanner" class="banner ok" role="status" aria-live="polite" style="display:none;"></div>
        <div id="badBanner" class="banner bad" role="alert" style="display:none;"></div>

        <p class="meta">提交後系統會自動電郵通知管理員（如已設定 SMTP）。</p>
      </form>
    </div>
  </main>

  <script>
    (function(){
      const $course   = document.getElementById('course');
      const $form     = document.getElementById('enrollForm');
      const $btn      = document.getElementById('submitBtn');
      const $ok       = document.getElementById('okBanner');
      const $bad      = document.getElementById('badBanner');

      function showOK(msg){ $ok.textContent = msg; $ok.style.display='block'; $bad.style.display='none'; }
      function showBAD(msg){ $bad.textContent = msg; $bad.style.display='block'; $ok.style.display='none'; }

      async function loadCourses(){
        try{
          const res = await fetch('/courses/options');
          const list = await res.json();

          // Clear & seed default option
          $course.innerHTML = '<option value="">請選擇課程…</option>';

          // Render options in ascending id (as returned)
          (list || []).forEach(c=>{
            const seats = (typeof c.seats === 'number') ? c.seats : 0;
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.name}（剩餘 ${seats}）`;
            if (seats <= 0) opt.disabled = true;
            $course.appendChild(opt);
          });
        }catch(e){
          console.error(e);
          showBAD('無法載入課程清單。');
        }
      }

      $form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const course_id = $course.value.trim();
        const full_name = document.getElementById('full_name').value.trim();
        const phone     = document.getElementById('phone').value.trim();
        const email     = document.getElementById('email').value.trim();
        const timezone  = document.getElementById('timezone').value.trim();
        const notes     = document.getElementById('notes').value.trim();

        if (!course_id){ showBAD('請先選擇課程。'); return; }
        if (!full_name){ showBAD('請輸入學生姓名。'); return; }

        $btn.disabled = true; $btn.textContent = '提交中…';

        try{
          const res = await fetch('/enroll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ course_id, full_name, phone, email, timezone, notes, source: 'web' })
          });
          const data = await res.json();

          if (!res.ok){
            showBAD(data && data.detail ? data.detail : '提交失敗，請稍後重試。');
          } else if (data && data.ok){
            showOK('報名成功！座位已扣減。');
            // reload seats count
            await loadCourses();
            // keep name/contacts for convenience
            document.getElementById('notes').value = '';
          } else {
            showBAD((data && data.message) || '抱歉，該課程可能已滿。');
            await loadCourses();
          }
        } catch(err){
          console.error(err);
          showBAD('系統繁忙，請稍後再試。');
        } finally {
          $btn.disabled = false; $btn.textContent = '提交報名';
        }
      });

      loadCourses();
    })();
  </script>
</body>
</html>
