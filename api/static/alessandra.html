<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alessandra • LiveKit Smoke Test</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#121833;--muted:#8ea0c8;--text:#eaf0ff;--accent:#4ea1ff}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Inter,Arial}
    .wrap{max-width:980px;margin:28px auto;padding:20px;background:var(--card);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.35)}
    h1{margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    input,button{border-radius:10px;border:0;padding:10px 12px}
    input{flex:1;min-width:220px;background:#0f1533;color:#eaf0ff}
    button{background:var(--accent);color:#061326;font-weight:700;cursor:pointer}
    video{width:100%;max-height:480px;background:#000;border-radius:12px;margin-top:10px}
    .log{background:#0f1533;border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word;min-height:90px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alessandra • Streaming Test (Professional Look)</h1>
    <p>Order: <b>Start</b> → you should see video/audio, then use <b>Say</b> to make Alessandra speak.</p>

    <div class="row">
      <button id="btnStart">Start</button>
      <button id="btnSay">Say</button>
      <button id="btnStop">Stop</button>
    </div>

    <div class="row">
      <input id="sayText" placeholder="What should Alessandra say?"
             value="Hello from the hotel concierge in Professional Look."/>
      <select id="mode">
        <option value="talk" selected>talk (LLM)</option>
        <option value="repeat">repeat (echo text)</option>
      </select>
    </div>

    <video id="vid" autoplay playsinline></video>
    <audio id="aud" autoplay></audio>

    <h3>Status</h3>
    <div class="log" id="log">ready…</div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const vid = document.getElementById('vid');
    const aud = document.getElementById('aud');
    const sayText = document.getElementById('sayText');
    const modeSel = document.getElementById('mode');

    let room = null;
    let session = null;

    const log = (m)=>{ logEl.textContent += `\n${new Date().toLocaleTimeString()}  ${m}`; logEl.scrollTop = logEl.scrollHeight; };

    async function start() {
      try {
        // Show what the server will use (reads HEYGEN_AVATAR_ID_Alessandra first)
        try {
          const idRes = await fetch('/heygen/avatar_id', { cache: 'no-store' });
          const idJ = await idRes.json();
          log("Server avatar_id = " + (idJ.avatar_id || 'n/a'));
        } catch(e) {
          log('Could not read /heygen/avatar_id (non-fatal).');
        }

        // Mint + start session (backend sets avatar_id)
        const r = await fetch('/heygen/token', { method:'POST' });
        const j = await r.json();
        log(`token status=${r.status}`);
        log(JSON.stringify(j, null, 2));

        const d = j.data || j;
        const wsUrl = d.url;
        const token = d.access_token;
        const session_id = d.session_id;
        if (!wsUrl || !token || !session_id) {
          log('Missing url/access_token/session_id in /heygen/token response.');
          return;
        }
        session = { session_id, url: wsUrl, access_token: token };

        // Connect to LiveKit
        room = new LivekitClient.Room();
        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
          if (track.kind === 'video') track.attach(vid);
          else if (track.kind === 'audio') track.attach(aud);
        });
        room.on(LivekitClient.RoomEvent.Disconnected, () => log('Disconnected'));
        await room.connect(wsUrl, token);
        log('Connected to LiveKit. Waiting for remote tracks…');
      } catch (e) {
        log('Start error: ' + (e?.message || e));
      }
    }

    async function say() {
      try {
        if (!session?.session_id) { log('Start first.'); return; }
        const text = sayText.value.trim();
        if (!text) { log('Enter something to say.'); return; }
        const task_type = modeSel.value; // "talk" or "repeat"
        const r = await fetch('/heygen/say', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ session_id: session.session_id, text, task_type })
        });
        log(`say → ${r.status}`);
        const t = await r.text(); log(t);
      } catch (e) {
        log('Say error: ' + (e?.message || e));
      }
    }

    async function stop() {
      try {
        if (room) { room.disconnect(); }
        vid.srcObject = null; aud.srcObject = null;
        session = null; room = null;
        log('Stopped.');
      } catch (e) {
        log('Stop error: ' + (e?.message || e));
      }
    }

    document.getElementById('btnStart').onclick = start;
    document.getElementById('btnSay').onclick = say;
    document.getElementById('btnStop').onclick = stop;
  </script>
</body>
</html>
